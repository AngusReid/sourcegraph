// +build ignore

package main

import (
	"text/template"

	"src.sourcegraph.com/sourcegraph/gen"
)

func main() {
	svcs := []string{
		"../../../../../go-sourcegraph/sourcegraph/sourcegraph.pb.go",
		"../../../../../Godeps/_workspace/src/sourcegraph.com/sourcegraph/srclib/store/pb/srcstore.pb.go",
		"../../../../../gitserver/gitpb/git_transport.pb.go",
	}
	gen.Generate("cached.go", tmpl, svcs, isCached)
}

func isCached(x *gen.Service) bool {
	return x.Name != "MultiRepoImporter" && x.Name != "GitTransport"
}

var tmpl = template.Must(template.New("").Delims("<<<", ">>>").Parse(`// GENERATED CODE - DO NOT EDIT!
//
// Generated by:
//
//   go run gen_cached.go
//
// Called via:
//
//   go generate
//

package cached

import (
	"golang.org/x/net/context"
	"sourcegraph.com/sourcegraph/go-vcs/vcs"
	"sourcegraph.com/sourcegraph/grpccache"
	"sourcegraph.com/sourcegraph/srclib/unit"
	"sourcegraph.com/sqs/pbtypes"
	"src.sourcegraph.com/sourcegraph/go-sourcegraph/sourcegraph"
	"src.sourcegraph.com/sourcegraph/svc"
)

// Wrap wraps services with an implementation of each service that sets grpccache trailers after each method returns.
func Wrap(s svc.Services) svc.Services {
	<<<range .>>>
	  if s.<<<.Name>>> != nil {
			s.<<<.Name>>> = &Cached<<<.Name>>>Server{s.<<<.Name>>>}
		}
	<<<end>>>
	return s
}

<<<range .>>>
	type Cached<<<.Name>>>Server struct{ sourcegraph.<<<.Name>>>Server }

	<<<$service := .>>>
	<<<range .Methods>>>
		func (s *Cached<<<$service.Name>>>Server) <<<.Name>>>(ctx context.Context, in <<<.ParamType>>>) (<<<.ResultType>>>, error) {
			ctx, cc := grpccache.Internal_WithCacheControl(ctx)
			result, err := s.<<<$service.Name>>>Server.<<<.Name>>>(ctx, in)
			if !cc.IsZero() {
				if err := grpccache.Internal_SetCacheControlTrailer(ctx, *cc); err != nil {
					return nil, err
				}
			}
			return result, err
		}
	<<<end>>>
<<<end>>>
`))
